default_platform(:android)

# Define project root and version file path\ nPROJECT_ROOT = File.expand_path("..", __dir__)
VERSION_FILE = File.join(PROJECT_ROOT, "version.properties")

# Helper: parse version.properties, skip blank/comments

def parse_version_props
  props = {}
  File.read(VERSION_FILE).each_line do |line|
    next if line.strip.empty? || line.strip.start_with?("#")
    key, value = line.strip.split("=", 2)
    props[key] = value
  end
  { name: props["VERSION_NAME"], code: props["VERSION_CODE"].to_i }
end

# Helper: write new version back

def write_version_props(new_name, new_code)
  File.open(VERSION_FILE, "w") do |f|
    f.puts("VERSION_NAME=#{new_name}")
    f.puts("VERSION_CODE=#{new_code}")
  end
end

platform :android do
  ########################################
  # Semantic version bump lanes
  ########################################

  desc "Bump patch version (x.y.Z → x.y.Z+1)"
  lane :bump_patch do
    v = parse_version_props
    major, minor, patch = v[:name].split(".").map(&:to_i)
    patch += 1
    new_name = [major, minor, patch].join(".")
    new_code = major * 10_000 + minor * 100 + patch
    write_version_props(new_name, new_code)

    Dir.chdir(PROJECT_ROOT) do
      sh("git add version.properties")
      sh("git commit -m 'chore: bump patch version to #{new_name}'")
    end
  end

  desc "Bump minor version (x.y.Z → x.(y+1).0)"
  lane :bump_minor do
    v = parse_version_props
    major, minor, _ = v[:name].split(".").map(&:to_i)
    minor += 1
    new_name = [major, minor, 0].join(".")
    new_code = major * 10_000 + minor * 100
    write_version_props(new_name, new_code)

    Dir.chdir(PROJECT_ROOT) do
      sh("git add version.properties")
      sh("git commit -m 'chore: bump minor version to #{new_name}'")
    end
  end

  desc "Bump major version (x.Y.Z → (x+1).0.0)"
  lane :bump_major do
    v = parse_version_props
    major, _, _ = v[:name].split(".").map(&:to_i)
    major += 1
    new_name = [major, 0, 0].join(".")
    new_code = major * 10_000
    write_version_props(new_name, new_code)

    Dir.chdir(PROJECT_ROOT) do
      sh("git add version.properties")
      sh("git commit -m 'chore: bump major version to #{new_name}'")
    end
  end

  ########################################
  # Other lanes: test, beta, deploy
  ########################################

  desc "Runs all the tests"
  lane :test do
    gradle(task: "test")
  end

  desc "Submit a new Beta Build to Crashlytics Beta"
  lane :beta do
    gradle(task: "clean assembleRelease")
    crashlytics
  end

  desc "Deploy a new version to the Google Play"
  lane :deploy do
    gradle(task: "clean assembleRelease")
    upload_to_play_store
  end
end